name: Auto Move Merged PR to Done

on:
  pull_request:
    types: [closed] # PR이 닫혔을 때 (머지 포함) 실행

jobs:
  move-to-done:
    runs-on: ubuntu-latest
    # PR이 '머지'되었을 때만 실행되도록 필터링
    if: github.event.pull_request.merged == true
    steps:
      - name: Move to Done
        run: |
          # 1. 프로젝트의 고유 Global ID 가져오기
          PROJECT_ID=$(gh project view 1 --owner "jiwon-tech-innovation" --format json --jq '.id')
          
          # 2. 'Status' 필드의 ID 가져오기
          FIELD_ID=$(gh project field-list 1 --owner "jiwon-tech-innovation" --format json --jq '.fields[] | select(.name=="Status") | .id')
          
          # 3. 'Done' 옵션의 ID 가져오기 (보드 상의 이름과 정확히 일치해야 함)
          OPTION_ID=$(gh project field-list 1 --owner "jiwon-tech-innovation" --format json --jq ".fields[] | select(.name==\"Status\") | .options[] | select(.name==\"Done\") | .id")
          
          # 4. 현재 PR에 해당하는 프로젝트 아이템 ID 찾기
          ITEM_ID=$(gh project item-list 1 --owner "jiwon-tech-innovation" --format json --jq ".items[] | select(.content.url==\"${{ github.event.pull_request.html_url }}\") | .id")
          
          # 5. 아이템이 존재할 경우에만 'Done'으로 상태 업데이트
          if [ -n "$ITEM_ID" ]; then
            gh project item-edit --id "$ITEM_ID" \
              --project-id "$PROJECT_ID" \
              --field-id "$FIELD_ID" \
              --single-select-option-id "$OPTION_ID"
          else
            echo "해당 PR이 프로젝트 보드에 등록되어 있지 않습니다."
          fi
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
