name: Auto Add & Move Merged PR (Supports Fork)

on:
  pull_request_target: # 포크된 PR에서도 시크릿을 사용하기 위해 변경
    types: [opened, closed]
    branches:
      - 'main'
      - 'develop*' # develop으로 시작하는 모든 브랜치 타겟

jobs:
  project-automation:
    runs-on: ubuntu-latest
    steps:
      # 1. PR이 생성되었을 때 (Opened)
      - name: Add PR to Project (Opened)
        if: github.event.action == 'opened'
        id: add_pr
        uses: actions/add-to-project@v1.0.1
        with:
          project-url: https://github.com/orgs/jiwon-tech-innovation/projects/1
          github-token: ${{ secrets.PROJECT_TOKEN }}

      # 2. PR이 머지되었을 때 (Closed & Merged)
      - name: Move to Done (Merged)
        if: github.event.action == 'closed' && github.event.pull_request.merged == true
        run: |
          PR_URL="${{ github.event.pull_request.html_url }}"
          
          # 프로젝트 및 필드 ID 가져오기
          PROJECT_ID=$(gh project view 1 --owner "jiwon-tech-innovation" --format json --jq '.id')
          FIELD_ID=$(gh project field-list 1 --owner "jiwon-tech-innovation" --format json --jq '.fields[] | select(.name=="Status") | .id')
          OPTION_ID=$(gh project field-list 1 --owner "jiwon-tech-innovation" --format json --jq ".fields[] | select(.name==\"Status\") | .options[] | select(.name==\"Done\") | .id")
          
          # 아이템 ID 찾기 후 Done으로 변경
          ITEM_ID=$(gh project item-list 1 --owner "jiwon-tech-innovation" --format json --jq ".items[] | select(.content.url==\"$PR_URL\") | .id")
          
          if [ -n "$ITEM_ID" ]; then
            gh project item-edit --id "$ITEM_ID" --project-id "$PROJECT_ID" --field-id "$FIELD_ID" --single-select-option-id "$OPTION_ID"
          fi
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
